<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>eRPH Guru PRO v4.2 — Muat mengikut Tahun (By-Year)</title>
<style>
:root{--bg:#f6f9ff;--card:#fff;--muted:#667085;--ink:#0b1b2b;--accent:#2563eb;--bd:#e6eef8;--radius:12px}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1100px;margin:20px auto;padding:16px}
.card{background:var(--card);border:1px solid var(--bd);border-radius:var(--radius);padding:12px;box-shadow:0 8px 22px rgba(10,45,90,.06);margin-bottom:12px}
.row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
label{display:flex;flex-direction:column;gap:.35rem;font-size:.95rem}
.input,select,textarea,button{font:inherit;padding:.55rem .75rem;border-radius:.6rem;border:1px solid var(--bd);background:#fff}
textarea{min-height:76px}
.button{cursor:pointer;border:1px solid var(--bd);background:transparent;border-radius:.6rem;padding:.55rem .75rem}
.button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.hint{color:var(--muted);font-size:.9rem}
.badge{display:inline-block;padding:.25rem .5rem;border-radius:.5rem;background:#f8fafc;border:1px solid var(--bd);font-size:.86rem}
.debug{font-family:ui-monospace,Menlo,Consolas;white-space:pre-wrap;background:#0b1220;color:#d7e3ff;border-radius:.6rem;padding:.7rem;border:1px solid #14213d;max-height:220px;overflow:auto}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem}
@media (max-width:900px){ .grid{grid-template-columns:repeat(2,1fr);} }
@media (max-width:560px){ .grid{grid-template-columns:1fr;} }
/* print */
@media print{ body{background:#fff} .no-print{display:none!important} @page{size:A4;margin:14mm} body *:not(.print-area):not(.print-area *){ display:none!important; visibility:hidden!important } }
.toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,.4);display:none;z-index:9999}
.toast.show{display:block}
</style>
</head>
<body>
<div class="container">

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong style="font-size:1.2rem">eRPH Guru PRO v4.2 — Muat ikut Tahun</strong>
        <div class="hint">Pilih set (tahun/kategori) untuk muat DSKP ringkas (cached di sessionStorage).</div>
      </div>
      <div class="row no-print">
        <select id="selSet" class="input">
          <option value="">— Pilih Set / Tahun —</option>
          <option value="1">Tahun 1</option>
          <option value="2">Tahun 2</option>
          <option value="3">Tahun 3</option>
          <option value="4">Tahun 4</option>
          <option value="5">Tahun 5</option>
          <option value="6">Tahun 6</option>
          <option value="PRA">Pra</option>
          <option value="Program Khas">Program Khas</option>
          <option value="Cuti Persekolahan">Cuti Persekolahan</option>
          <option value="Murid Ceria Guru Bahagia">Murid Ceria Guru Bahagia</option>
        </select>
        <button id="btnLoadSet" class="button">Muat Set</button>
        <button id="btnAutoLoad" class="button">Muat semula dskp.csv</button>
        <button id="btnManualImport" class="button">Import Manual</button>
      </div>
    </div>
  </div>

  <!-- remain UI (profile, import debug, form...) -->
  <!-- For brevity reuse earlier UI structure: profile, import log, RPH form, preview -->
  <!-- Profile -->
  <section class="card">
    <div class="row">
      <label>Sekolah <input id="school" class="input" placeholder="Contoh: SK Contoh Jaya"></label>
      <label>Nama Guru <input id="teacher" class="input" placeholder="Contoh: Cikgu Aisyah"></label>
      <label>Emel Guru <input id="teacherEmail" class="input" placeholder="contoh@moe.edu.my" type="email"></label>
    </div>
    <div style="margin-top:.6rem;display:flex;justify-content:space-between;align-items:center">
      <div class="hint">Profil disimpan di peranti (localStorage).</div>
      <div class="row no-print">
        <button id="btnReset" class="button">Reset</button>
      </div>
    </div>
  </section>

  <!-- Import / Debug -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Import DSKP (Per-Set)</strong>
      <span id="lblDSKPStatus" class="badge">Belum import</span>
    </div>

    <div style="margin-top:.6rem" class="row">
      <input id="fileDSKP" type="file" accept=".csv,text/csv" style="display:none">
      <button id="btnChooseFile" class="button">Pilih Fail</button>
      <button id="btnPasteCSV" class="button">Tampal CSV</button>
      <button id="btnClearDSKP" class="button">Kosongkan DSKP</button>
      <div class="hint" style="margin-left:auto">Jika auto/fetch gagal, guna Import Manual.</div>
    </div>

    <div style="margin-top:.8rem">
      <strong>Log</strong>
      <div id="debug" class="debug">— tiada log —</div>
    </div>
  </section>

  <!-- RPH form (kept minimal for this patch) -->
  <section class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem">
      <strong>Borang RPH</strong>
      <div class="row no-print">
        <button id="btnSave" class="button">Simpan</button>
        <button id="btnPrint" class="button">Cetak</button>
        <button id="btnSubmit" class="button primary">Hantar ke Penyemak</button>
      </div>
    </div>

    <div class="grid">
      <label>Tarikh <input id="tarikh" class="input" type="date"></label>
      <label>Kelas <input id="kelas" class="input" placeholder="cth: 2 Safa"></label>
      <label>Tahun <select id="selTahun" class="input"></select></label>
      <label>Subjek <select id="selSubjek" class="input"></select></label>

      <label>Unit <select id="selUnit" class="input"></select></label>
      <label>Tajuk <select id="selTajuk" class="input"></select></label>
      <label>SK <select id="selSK" class="input"></select></label>
      <label>SP <select id="selSP" class="input"></select></label>

      <label>Masa Mula <input id="tMul" class="input" type="time"></label>
      <label>Masa Tamat <input id="tTam" class="input" type="time"></label>
      <label>Jenis Pentaksiran <select id="assess" class="input"><option>Formatif</option><option>Sumatif</option><option>Pemerhatian</option><option>Lisan</option><option>Bertulis</option></select></label>
      <div></div>

      <label style="grid-column:1/-1">Objektif PdPc<textarea id="obj" class="input" placeholder="Objektif PdPc"></textarea></label>
      <label style="grid-column:1/-1">Aktiviti PdPc<textarea id="aktiviti" class="input" placeholder="Aktiviti / langkah utama"></textarea></label>
      <label style="grid-column:1/-1">BBM / Sumber<textarea id="bbm" class="input" placeholder="Buku teks, LKM, pautan"></textarea></label>
      <label style="grid-column:1/-1">Refleksi PdPc<textarea id="refleksi" class="input" placeholder="Refleksi / penambahbaikan"></textarea></label>
    </div>
  </section>

  <!-- preview -->
  <section class="card print-area">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem">
      <strong>Pratonton RPH (untuk cetak)</strong>
      <div class="hint">Cetak hanya kawasan ini.</div>
    </div>

    <div style="border:1px solid var(--bd);border-radius:8px;padding:10px;background:#fff">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div style="font-weight:700" id="pSchool">—</div>
        <div id="pMeta" class="hint">—</div>
      </div>
      <hr style="margin:.6rem 0">
      <div style="display:grid;grid-template-columns:140px 1fr;gap:6px">
        <div style="font-weight:600">Tarikh</div><div id="pTarikh">—</div>
        <div style="font-weight:600">Kelas & Subjek</div><div id="pKelas">—</div>
        <div style="font-weight:600">Masa</div><div id="pMasa">—</div>
        <div style="font-weight:600">Unit & Tajuk</div><div id="pUnit">—</div>
        <div style="font-weight:600">SK</div><div id="pSK">—</div>
        <div style="font-weight:600">SP</div><div id="pSP">—</div>
        <div style="font-weight:600">Objektif</div><div id="pObj">—</div>
        <div style="font-weight:600">Aktiviti</div><div id="pAkt">—</div>
        <div style="font-weight:600">BBM</div><div id="pBBM">—</div>
        <div style="font-weight:600">Pentaksiran</div><div id="pPen">—</div>
        <div style="font-weight:600">Refleksi</div><div id="pRef">—</div>
      </div>
      <div style="margin-top:.6rem" id="pFooter" class="hint">—</div>
    </div>
  </section>

</div>

<div id="toast" class="toast">—</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const KEY_PROFILE = 'erph_byyear_profile';
  const KEY_FORM = 'erph_byyear_form';
  const KEY_SESSION_DSKP = 'erph_byyear_dskp'; // saved to sessionStorage to avoid quota issue
  const debugLines = [];

  function debug(msg){
    const t = new Date().toLocaleTimeString();
    debugLines.unshift(t + ' ' + msg);
    if(debugLines.length>300) debugLines.pop();
    $('debug').textContent = debugLines.join('\n');
    console.log(msg);
  }
  function toast(msg, t=2200){ const el=$('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), t); }

  // save/load profile & form
  function saveProfile(){ const profile = {school:$('school').value, teacher:$('teacher').value, email:$('teacherEmail').value}; try{ localStorage.setItem(KEY_PROFILE, JSON.stringify(profile)); }catch(e){} }
  function loadProfile(){ try{ const p=JSON.parse(localStorage.getItem(KEY_PROFILE)||'null'); if(p){ $('school').value=p.school||''; $('teacher').value=p.teacher||''; $('teacherEmail').value=p.email||''; } }catch(e){} }
  function persistForm(){ const f = { tarikh:$('tarikh').value, kelas:$('kelas').value, tMul:$('tMul').value, tTam:$('tTam').value, assess:$('assess').value, obj:$('obj').value, aktiviti:$('aktiviti').value, bbm:$('bbm').value, refleksi:$('refleksi').value, selTahun:$('selTahun').value, selSubjek:$('selSubjek').value, selUnit:$('selUnit').value, selTajuk:$('selTajuk').value, selSK:$('selSK').value, selSP:$('selSP').value }; try{ localStorage.setItem(KEY_FORM, JSON.stringify(f)); }catch(e){} }

  // CSV parser (same robust one)
  function normalizeHeader(h){ h = String(h||'').replace(/^\uFEFF/,'').trim().toLowerCase().replace(/\s+/g,' '); const map={'tahun':'tahun','taun':'tahun','subjek':'subjek','subject':'subjek','unit':'unit','tajuk':'tajuk','title':'tajuk','sk':'sk','standard kandungan':'sk','sp':'sp','standard pembelajaran':'sp','tema':'tema'}; return map[h]||h.replace(/[^a-z0-9]/g,'_'); }
  function splitRow(line, delim){ const out=[]; let cur=''; let q=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; } else if(ch===delim && !q){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur); return out; }
  function parseFlexibleCSV(text){ const linesAll = text.split(/\r?\n/); const lines = linesAll.filter(l=>l.trim().length>0); if(!lines.length) return {rows:[],delim:',',headers:[]}; const head = lines[0]; const counts = [{d:';',c:(head.match(/;/g)||[]).length},{d:'\t',c:(head.match(/\t/g)||[]).length},{d:',',c:(head.match(/,/g)||[]).length}].sort((a,b)=>b.c-a.c); const delim = counts[0].c>0?counts[0].d:','; const raw = splitRow(head,delim); const headers = raw.map(h=>normalizeHeader(h)); const rows=[]; for(let i=1;i<lines.length;i++){ const cells = splitRow(lines[i],delim); if(cells.length>headers.length){ const extra = cells.slice(headers.length-1).join(delim); cells.splice(headers.length-1, cells.length-(headers.length-1), extra); } const obj={}; for(let j=0;j<headers.length;j++) obj[headers[j]] = (cells[j] ?? '').trim(); rows.push(obj);} return {rows,delim,headers}; }

  // map parsed rows to canonical records (only keep core fields)
  function mapRow(o){ return { tahun:(o.tahun||o.year||'').trim(), subjek:(o.subjek||o.subject||'').trim(), unit:(o.unit||'').trim(), tajuk:(o.tajuk||o.title||'').trim(), sk:(o.sk||'').trim(), sp:(o.sp||'').trim(), tema:(o.tema||'').trim(), kemahiran:(o.kemahiran||'').trim(), nilaiteras:(o.nilaiteras||'').trim(), _raw:o }; }

  // load DSKP text and process
  function processCSVText(text, sourceLabel){
    if(!text || !text.trim()){ debug('Import gagal: kosong'); toast('Import kosong'); return; }
    text = text.replace(/^\uFEFF/,'');
    const {rows, delim, headers} = parseFlexibleCSV(text);
    if(!rows.length){ debug('Tiada baris dikesan'); toast('Tiada baris dikesan'); return; }
    const mapped = rows.map(mapRow);
    // store to sessionStorage to avoid quota issues
    try{
      sessionStorage.setItem(KEY_SESSION_DSKP, JSON.stringify(mapped));
      debug(`DSKP dimuat (${mapped.length}) — sumber: ${sourceLabel}`);
      $('lblDSKPStatus').textContent = `Dimuat: ${mapped.length} rekod (sumber: ${sourceLabel})`;
      toast('DSKP dimuat');
    }catch(e){
      debug('sessionStorage gagal: ' + e);
      toast('DSKP dimuat (tidak cached)');
      // still keep mapped in memory for this session
      window.__DSKP_TEMP = mapped;
      $('lblDSKPStatus').textContent = `Dimuat: ${mapped.length} rekod (sumber: ${sourceLabel}, no cache)`;
    }
    // build dropdowns using loaded data
    buildAllDropdowns();
  }

  // fetch helper: try url and return text or throw
  async function fetchText(url){
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP ' + res.status);
    return await res.text();
  }

  // attempt auto-load default dskp.csv
  async function tryAutoLoadDefault(){
    debug('Mencuba muat auto ./dskp.csv');
    try{
      const txt = await fetchText('./dskp.csv');
      processCSVText(txt, 'dskp.csv');
      return true;
    }catch(e){
      debug('Auto-load ./dskp.csv gagal: ' + e);
      return false;
    }
  }

  // attempt to load per-set file (DSKP_v5opt_T{key}.csv)
  async function tryLoadSet(key){
    if(!key) { toast('Sila pilih set'); return; }
    // encode key for filename safety
    const safeKey = encodeURIComponent(key);
    const filename = `./DSKP_v5opt_T${safeKey}.csv`;
    debug('Mencuba muat: ' + filename);
    try{
      const txt = await fetchText(filename);
      processCSVText(txt, `DSKP_v5opt_T${key}.csv`);
      return true;
    }catch(e){
      debug('Muat set gagal: ' + e);
      toast('Muat set gagal (sila pastikan file ada di root)');
      return false;
    }
  }

  // UI wiring
  document.addEventListener('DOMContentLoaded', ()=>{

    // load profile/form from storage
    loadProfile();
    try{ const savedForm = JSON.parse(localStorage.getItem(KEY_FORM)||'null'); if(savedForm){ $('tarikh').value = savedForm.tarikh || new Date().toISOString().slice(0,10); $('tMul').value = savedForm.tMul||''; $('tTam').value = savedForm.tTam||''; } }catch(e){}

    // buttons
    $('btnChooseFile').addEventListener('click', ()=> $('fileDSKP').click());
    $('fileDSKP').addEventListener('change', (e)=> {
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> processCSVText(String(reader.result||''), f.name);
      reader.onerror = ()=> { debug('FileReader error'); toast('Gagal baca fail'); };
      reader.readAsText(f, 'UTF-8');
    });
    $('btnPasteCSV').addEventListener('click', ()=> {
      const t = prompt('Tampal CSV di sini (Cancel untuk batal):');
      if(t) processCSVText(String(t), 'pasted');
    });
    $('btnClearDSKP').addEventListener('click', ()=> {
      if(!confirm('Kosongkan DSKP yang dimuat?')) return;
      sessionStorage.removeItem(KEY_SESSION_DSKP); window.__DSKP_TEMP = null; $('lblDSKPStatus').textContent = 'Belum import'; debug('DSKP cleared'); toast('DSKP dikosongkan');
      buildAllDropdowns(); // rebuild with empty
    });

    $('btnAutoLoad').addEventListener('click', async ()=> {
      const ok = await tryAutoLoadDefault();
      if(!ok) toast('Auto-load dskp.csv gagal — guna pilih set atau import manual');
    });

    $('btnLoadSet').addEventListener('click', async ()=> {
      const key = $('selSet').value;
      await tryLoadSet(key);
    });

    $('btnManualImport').addEventListener('click', ()=> {
      $('fileDSKP').click();
    });

    $('btnSave').addEventListener('click', ()=> {
      persistForm(); saveProfile(); toast('Disimpan'); debug('Form & profile disimpan');
    });

    $('btnPrint').addEventListener('click', ()=> { persistForm(); renderPreview(); window.print(); });
    $('btnSubmit').addEventListener('click', ()=> { persistForm(); toast('Telah dihantar ke penyemak'); debug('Hantar: notifikasi'); });
    $('btnReset').addEventListener('click', ()=> {
      if(!confirm('Kosongkan semua data?')) return;
      localStorage.removeItem(KEY_PROFILE); localStorage.removeItem(KEY_FORM); sessionStorage.removeItem(KEY_SESSION_DSKP);
      window.__DSKP_TEMP = null; $('school').value=''; $('teacher').value=''; $('teacherEmail').value=''; $('tarikh').value=new Date().toISOString().slice(0,10);
      $('kelas').value=''; $('obj').value=''; $('aktiviti').value=''; $('bbm').value=''; $('refleksi').value='';
      $('lblDSKPStatus').textContent='Belum import'; buildAllDropdowns(); renderPreview(); toast('Semua data dikosongkan'); debug('Reset semua');
    });

    // attempt auto-load default first
    tryAutoLoadDefault().then(ok=>{
      if(!ok){
        // if default failed, try to load sessionStorage cached set
        try{
          const s = sessionStorage.getItem(KEY_SESSION_DSKP);
          if(s){ const parsed = JSON.parse(s); window.__DSKP_TEMP = parsed; $('lblDSKPStatus').textContent = `Dimuat: ${parsed.length} rekod (cached)`; buildAllDropdowns(); debug('DSKP dimuat dari sessionStorage'); }
        }catch(e){}
      }
    });

  }); // end DOMContentLoaded

  // build dropdowns and preview using in-session DSKP
  function getDSKP(){
    try{
      const s = sessionStorage.getItem(KEY_SESSION_DSKP);
      if(s) return JSON.parse(s);
    }catch(e){}
    if(window.__DSKP_TEMP) return window.__DSKP_TEMP;
    return [];
  }

  function buildAllDropdowns(){
    const D = getDSKP();
    // populate selTahun from data years (if not provided use options)
    const years = Array.from(new Set(D.map(x=>x.tahun).filter(Boolean))).sort();
    fillOptions('selTahun', years.length? years : ['']);
    fillOptions('selSubjek', Array.from(new Set(D.map(x=>x.subjek).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ms')));
    fillOptions('selUnit', []);
    fillOptions('selTajuk', []);
    fillOptions('selSK', []);
    fillOptions('selSP', []);
  }

  function fillOptions(id, arr){
    const sel = $(id);
    sel.innerHTML = '';
    (arr||[]).forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    if(arr && arr.length) sel.value = sel.value || arr[0];
  }

  // cascade
  ['selTahun','selSubjek','selUnit','selTajuk','selSK'].forEach(id=>{
    document.addEventListener('change',(e)=>{ if(e.target && e.target.id === id) cascade(id); });
  });

  function cascade(fromId){
    const D = getDSKP();
    const year = $('selTahun').value || '';
    let subs = Array.from(new Set(D.map(x=>x.subjek))).sort((a,b)=>a.localeCompare(b,'ms'));
    if(year) { const byY=D.filter(x=>x.tahun===year); if(byY.length) subs = Array.from(new Set(byY.map(x=>x.subjek))).sort((a,b)=>a.localeCompare(b,'ms')); }
    fillOptions('selSubjek', subs);
    const subj = $('selSubjek').value || '';
    const bySubj = D.filter(x=> (year? x.tahun===year : true) && (subj? x.subjek===subj : true));
    fillOptions('selUnit', Array.from(new Set(bySubj.map(x=>x.unit))).sort((a,b)=>a.localeCompare(b,'ms')));
    const unit = $('selUnit').value || '';
    const byUnit = bySubj.filter(x=> unit? x.unit===unit : true);
    fillOptions('selTajuk', Array.from(new Set(byUnit.map(x=>x.tajuk))).sort((a,b)=>a.localeCompare(b,'ms')));
    const tajuk = $('selTajuk').value || '';
    const byTajuk = byUnit.filter(x=> tajuk? x.tajuk===tajuk : true);
    fillOptions('selSK', Array.from(new Set(byTajuk.map(x=>x.sk))).sort((a,b)=>a.localeCompare(b,'ms')));
    const sk = $('selSK').value || '';
    const bySK = byTajuk.filter(x=> sk? x.sk===sk : true);
    fillOptions('selSP', Array.from(new Set(bySK.map(x=>x.sp))).sort((a,b)=>a.localeCompare(b,'ms')));
    persistForm(); renderPreview();
  }

  function renderPreview(){
    const profile = (function(){ try{ return JSON.parse(localStorage.getItem(KEY_PROFILE)||'null')||{} }catch(e){return{}} })();
    $('pSchool').textContent = profile.school || $('school').value || '—';
    $('pMeta').textContent = (profile.teacher||$('teacher').value||'—') + ((profile.email||$('teacherEmail').value)? ' • ' + (profile.email||$('teacherEmail').value):'');
    $('pTarikh').textContent = $('tarikh').value || '—';
    $('pKelas').textContent = 'Kelas: ' + ($('kelas').value || '—') + ' — ' + ($('selSubjek').value||'—') + ' (Tahun ' + ($('selTahun').value||'—') + ')';
    $('pMasa').textContent = ($('tMul').value||'—') + ' — ' + ($('tTam').value||'—');
    $('pUnit').textContent = 'Unit: ' + ($('selUnit').value||'—') + ' — ' + ($('selTajuk').value||'—');
    $('pSK').textContent = $('selSK').value || '—';
    $('pSP').textContent = $('selSP').value || '—';
    $('pObj').textContent = $('obj').value || '—';
    $('pAkt').textContent = $('aktiviti').value || '—';
    $('pBBM').textContent = $('bbm').value || '—';
    $('pPen').textContent = $('assess').value || '—';
    $('pRef').textContent = $('refleksi').value || '—';
    $('pFooter').textContent = 'Disediakan oleh ' + (profile.teacher||$('teacher').value||'—') + ' • ' + new Date().toLocaleString('ms-MY',{dateStyle:'medium',timeStyle:'short'});
  }

})(); // IIFE end
</script>
</body>
</html>
